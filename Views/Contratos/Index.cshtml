@{
	ViewData["Title"] = "Index";
	var listaInquilinos = ViewBag.ListaInquilinos as List<Inquilino> ?? new List<Inquilino>();
	var listaInmuebles = ViewBag.ListaInmuebles as List<Inmueble> ?? new List<Inmueble>();
	var Pagina = ViewBag.Pagina ?? 1;
	var TotalPaginas = ViewBag.TotalPaginas ?? 1;
	var TotalRegistros = ViewBag.TotalRegistros ?? 0;
	int tamPagina = 10;
}

<div class="row">
	<div class="col-12">
		<div class="card">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h3 class="card-title mb-0">
					<i class="fas fa-users me-2"></i>Seleccionar Inquilino para Nuevo Contrato
				</h3>
			</div>
			<div class="card-body">
				<div class="row mb-3">
					<div class="col-12">
						<p class="text-muted mb-0">
							Mostrando @((Pagina - 1) * tamPagina + 1) a
							@Math.Min(Pagina * tamPagina, TotalRegistros) de
							@TotalRegistros inquilinos
						</p>
					</div>
				</div>
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-striped table-hover">
							<thead class="table-dark">
								<tr>
									<th>ID</th>
									<th>Nombre</th>
									<th>Apellido</th>
									<th>DNI</th>
									<th>Teléfono</th>
									<th>Email</th>
									<th>Estado</th>
									<th>Acciones</th>
								</tr>
							</thead>
							<tbody>
								@if (listaInquilinos != null && listaInquilinos.Any())
								{
									foreach (var item in listaInquilinos)
									{
										<tr>
											<td>@item.Id</td>
											<td>@item.Persona.Nombre</td>
											<td>@item.Persona.Apellido</td>
											<td>@item.Persona.Dni</td>
											<td>@(item.Persona.Telefono ?? "-")</td>
											<td>@(item.Persona.Email ?? "-")</td>
											<td class="text-center">
												@if (item.Estado == "ACTIVO")
												{
													<span class="badge bg-success">ACTIVO</span>
												}
												else
												{
													<span class="badge bg-secondary">@item.Estado</span>
												}
											</td>
											<td class="text-center">
												<button type="button" class="btn btn-sm btn-outline-primary btn-abrir-inmuebles"
													data-inquilino-id="@item.Id" data-bs-toggle="modal"
													data-bs-target="#modalInmuebles" title="Seleccionar Inmueble">
													<i class="fas fa-building me-1"></i>Seleccionar Inmueble
												</button>
											</td>
										</tr>
									}
								}
								else
								{
									<tr>
										<td colspan="8" class="text-center text-muted py-4">
											<i class="fas fa-info-circle me-2"></i>No se registran inquilinos activos
										</td>
									</tr>
								}
							</tbody>
						</table>
					</div>

					@* Paginación *@
					@if (TotalPaginas > 1)
					{
						<nav aria-label="Navegación de páginas">
							<ul class="pagination justify-content-center">
								<li class="page-item @(Pagina <= 1 ? "disabled" : "")">
									<a class="page-link" href="~/Contratos/Index?pagina=@(Pagina - 1)">
										<i class="fas fa-angle-left"></i> Anterior
									</a>
								</li>

								@for (int i = 1; i <= TotalPaginas; i++)
								{
									<li class="page-item @(i == Pagina ? "active" : "")">
										<a class="page-link" href="~/Contratos/Index?pagina=@i">@i</a>
									</li>
								}

								<li class="page-item @(Pagina >= TotalPaginas ? "disabled" : "")">
									<a class="page-link" href="~/Contratos/Index?pagina=@(Pagina + 1)">
										Siguiente <i class="fas fa-angle-right"></i>
									</a>
								</li>
							</ul>
						</nav>
					}
				</div>
			</div>
		</div>
	</div>





	<!-- Modal para seleccionar inmueble -->
	<div class="modal fade" id="modalInmuebles" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div style="width: 1000px;" class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Seleccionar Inmueble</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<!-- Filtros de fecha -->
					<div class="row mb-3">
						<div class="col-md-6">
							<label for="fechaInicio" class="form-label">Fecha de Inicio del Contrato</label>
							<input type="date" id="fechaInicio" class="form-control" required>
						</div>
						<div class="col-md-6">
							<label for="fechaFin" class="form-label">Fecha de Fin del Contrato</label>
							<input type="date" id="fechaFin" class="form-control" required>
						</div>
					</div>
					<div class="row mb-3">
						<div class="col-12">
							<button type="button" id="btnFiltrarInmuebles" class="btn btn-primary">
								<i class="fas fa-search me-1"></i>Buscar Inmuebles Disponibles
							</button>
						</div>
					</div>
					<div id="contenedorInmuebles">
						<p class="text-muted">Seleccione las fechas del contrato para ver los inmuebles disponibles.</p>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!-- Modal Formulario Contrato -->
	<div class="modal fade" id="modalContrato" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content">
				<div class="card">
					<div class="card-header d-flex justify-content-between align-items-center">
						<h5 class="card-title mb-0">
							<i class="fas fa-file-contract me-2"></i>Nuevo Contrato
						</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
					</div>
					<div class="card-body">
						<form id="formContrato" method="post" asp-action="Crear">
							<div class="row g-3">
								<div class="col-md-6">
									<label for="InmuebleId" class="form-label">Inmueble ID</label>
									<input type="number" id="InmuebleId" name="InmuebleId" class="form-control"
										placeholder="Ej: 101" readonly required>
								</div>
								<div class="col-md-6">
									<label for="InquilinoId" class="form-label">Inquilino ID</label>
									<input type="number" id="InquilinoId" name="InquilinoId" class="form-control"
										placeholder="Ej: 202" readonly required>
								</div>
								<div class="col-md-6">
									<label for="FechaInicio" class="form-label">Fecha Inicio</label>
									<input type="date" id="FechaInicio" name="FechaInicio" class="form-control"
										required>
								</div>
								<div class="col-md-6">
									<label for="FechaFin" class="form-label">Fecha Fin</label>
									<input type="date" id="FechaFin" name="FechaFin" class="form-control" required>
								</div>
								<div class="col-md-6">
									<label for="FechaVencimiento" class="form-label">Vencimiento de pagos</label>
									<select id="FechaVencimiento" name="FechaVencimiento" class="form-select" required>
										<option value="">-- Selección --</option>
										<option value="5">Día 5 de cada mes</option>
										<option value="10">Día 10 de cada mes</option>
										<option value="15">Día 15 de cada mes</option>
										<option value="20">Día 20 de cada mes</option>
									</select>
								</div>
								<div class="col-md-6">
									<label for="Moneda" class="form-label">Moneda</label>
									<select id="Moneda" name="Moneda" class="form-select" required>
										<option value="">-- Selección --</option>
										<option value="ARS">ARS</option>
										<option value="USD">USD</option>
									</select>
								</div>
								<div class="col-md-6">
									<label for="MontoMensual" class="form-label">Monto Mensual</label>
									<input type="number" id="MontoMensual" name="MontoMensual" class="form-control"
										step="0.01" required>
								</div>
								<div class="col-md-6">
									<label for="Deposito" class="form-label">Depósito</label>
									<input type="number" id="Deposito" name="Deposito" class="form-control" step="0.01"
										required>
								</div>
								<div class="col-12">
									<label for="Observaciones" class="form-label">Observaciones</label>
									<textarea id="Observaciones" name="Observaciones" class="form-control" rows="3"
										required></textarea>
								</div>
							</div>
						</form>
					</div>
					<div class="card-footer d-flex justify-content-between">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
							<i class="fas fa-times me-1"></i>Cancelar
						</button>
						<button type="button" class="btn btn-primary" form="formContrato" id="guardarContrato">
							<i class="fas fa-save me-1"></i>Guardar Contrato
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>



	<!-- Modal Confirmación -->
	<div class="modal fade" id="modalConfirmacion" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Confirmar Envío de Contrato</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
				</div>
				<div class="modal-body" id="confirmBody">
					<!-- Datos se llenan con JS -->
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
					<button type="button" class="btn btn-primary" id="confirmarContrato">Confirmar</button>
				</div>
			</div>
		</div>
	</div>

@section Scripts {
		<script>
			@if (!ViewData.ModelState.IsValid)
				{
				            foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
					{
						<text>
							toastr.options = {
								"positionClass": "toast-top-center",
							"timeOut": "5000"
						                    };
							toastr.error("@error.ErrorMessage");
						</text>
				}
				}
		</script>
		<script>

				// Función para cargar inmuebles en el modal. 
				function cargarInmueble(pagina, fechaInicio = null, fechaFin = null) {
					let url = '/Inmueble/ListarParaSeleccionInmuebles?pagina=' + pagina;
					if (fechaInicio && fechaFin) {
						url += '&fechaInicio=' + fechaInicio + '&fechaFin=' + fechaFin;
					}
					
					$.get(url, function (data) {
						$('#contenedorInmuebles').html(data);
					});
				}

			// Cuando se abre el modal, no cargamos inmuebles hasta que se seleccionen fechas
			$('#modalInmuebles').on('shown.bs.modal', function () {
				$('#contenedorInmuebles').html('<p class="text-muted">Seleccione las fechas del contrato para ver los inmuebles disponibles.</p>');
			});

			// Evento para el botón de filtrar inmuebles
			$('#btnFiltrarInmuebles').on('click', function () {
				let fechaInicio = $('#fechaInicio').val();
				let fechaFin = $('#fechaFin').val();
				
				if (!fechaInicio || !fechaFin) {
					alert('Por favor seleccione ambas fechas del contrato.');
					return;
				}
				
				if (new Date(fechaFin) <= new Date(fechaInicio)) {
					alert('La fecha de fin debe ser posterior a la fecha de inicio.');
					return;
				}
				
				cargarInmueble(1, fechaInicio, fechaFin);
			});

			// Delegamos el click en la paginación
			$(document).on('click', '.cargar-pagina', function () {
				let pagina = $(this).data('pagina');
				let fechaInicio = $('#fechaInicio').val();
				let fechaFin = $('#fechaFin').val();
				cargarInmueble(pagina, fechaInicio, fechaFin);
			});

			// Delegamos el click en "Seleccionar"
			$(document).on('click', '.seleccionar-inmueble', function () {
				//El id del inmueble lo obtenemos del data set en el boton seleccionar de _ListaInmueblesSeleccion Partial
				let inmuebleId = $(this).data('id');

				//El id de inquilino lo obtenemos del data set del boton que abre el modal
				let inquilinoId = $('.btn-abrir-inmuebles').data('inquilino-id');

				// Obtener las fechas del modal de inmuebles
				let fechaInicio = $('#fechaInicio').val();
				let fechaFin = $('#fechaFin').val();

				$('#InmuebleId').val(inmuebleId);
				$('#InquilinoId').val(inquilinoId);
				
				// Copiar las fechas al formulario del contrato
				$('#FechaInicio').val(fechaInicio);
				$('#FechaFin').val(fechaFin);

				// Cerrar modal de inmuebles
				$('#modalInmuebles').modal('hide');

				// Abrir modal de contrato
				const contratoModal = new bootstrap.Modal(document.getElementById('modalContrato'));
				contratoModal.show();
			});



			document.getElementById("guardarContrato").addEventListener("click", () => {
				const form = document.getElementById("formContrato");


				if (!form.checkValidity()) {
					form.reportValidity();
					return;
				}
				const fechaInicio = new Date(document.getElementById("FechaInicio").value);
				const fechaFin = new Date(document.getElementById("FechaFin").value);


				const fechaMinima = new Date(fechaInicio);
				fechaMinima.setMonth(fechaMinima.getMonth() + 6);


				if (fechaMinima.getDate() !== fechaInicio.getDate()) {
					fechaMinima.setDate(0);
				}

				if (fechaFin < fechaMinima) {
					toastr.options = {

						"positionClass": "toast-top-center",

					};
					toastr.error("La Fecha Fin debe ser al menos 6 meses después de la Fecha Inicio.");
					return;
				}

				const confirmModal = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
				const body = document.getElementById("confirmBody");
				body.innerHTML = `
								<p><strong>Inmueble ID:</strong> ${document.getElementById("InmuebleId").value}</p>
								<p><strong>Inquilino ID:</strong> ${document.getElementById("InquilinoId").value}</p>
								<p><strong>Fecha Inicio:</strong> ${document.getElementById("FechaInicio").value}</p>
								<p><strong>Fecha Fin:</strong> ${document.getElementById("FechaFin").value}</p>
								<p><strong>Moneda:</strong> ${document.getElementById("Moneda").value}</p>
								<p><strong>Monto Mensual:</strong> ${document.getElementById("MontoMensual").value}</p>
								<p><strong>Depósito:</strong> ${document.getElementById("Deposito").value}</p>
								<p><strong>Observaciones:</strong> ${document.getElementById("Observaciones").value}</p>
								`;
				bootstrap.Modal.getInstance(document.getElementById('modalContrato')).hide();
				confirmModal.show();
			});


			document.getElementById("confirmarContrato").addEventListener("click", () => {

				const form = document.getElementById("formContrato");


				form.submit();


				bootstrap.Modal.getInstance(document.getElementById('modalConfirmacion')).hide();
			});

		</script>
}