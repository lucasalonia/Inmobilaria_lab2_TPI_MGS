@{
	ViewData["Title"] = "Index";
	var listaInquilinos = ViewBag.ListaInquilinos as List<Inquilino> ?? new List<Inquilino>();
	var listaInmuebles = ViewBag.ListaInmuebles as List<Inmueble> ?? new List<Inmueble>();
	var Pagina = ViewBag.Pagina ?? 1;
	var TotalPaginas = ViewBag.TotalPaginas ?? 1;
}

<h1>Inquilinos Sin Contrato Vigente</h1>

<table class="table table-striped">
	<thead>
		<tr>
			<th>Id</th>
			<th>Nombre</th>
			<th>Apellido</th>
			<th>DNI</th>
			<th>Telefono</th>
			<th>E-mail</th>
			<th>Acciones</th>
		</tr>
	</thead>
	<tbody>
		@if (listaInquilinos != null && listaInquilinos.Any())
		{
			@foreach (var item in listaInquilinos)
			{
				<tr>
					<td>@item.Id</td>
					<td>@item.Persona.Nombre</td>
					<td>@item.Persona.Apellido</td>
					<td>@item.Persona.Dni</td>
					<td>@item.Persona.Telefono</td>
					<td>@item.Persona.Email</td>
					<td>
						<button type="button" class="btn btn-primary btn-abrir-inmuebles" data-inquilino-id="@item.Id"
							data-bs-toggle="modal" data-bs-target="#modalInmuebles">
							Seleccionar Inmueble
						</button>
					</td>
				</tr>
			}
		}
		else
		{
			<tr>
				<td colspan="8" class="text-center text-muted py-4">
					<i class="fas fa-info-circle me-2"></i>
					No se registran inquilinos sin contrato
				</td>
			</tr>
		}
	</tbody>
</table>





<!-- Modal para seleccionar propietario -->
<div class="modal fade" id="modalInmuebles" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div style="width: 1000px;" class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Seleccionar Inmueble</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body" id="contenedorInmuebles">
			</div>
		</div>
	</div>
</div>


<!-- Modal Formulario Contrato -->
<div class="modal fade" id="modalContrato" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Nuevo Contrato</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
			</div>
			<div class="modal-body">
				<form id="formContrato" method="post" asp-action="Crear">
					<div class="row g-3">
						<div class="col-md-6">
							<label for="InmuebleId" class="form-label">Inmueble ID</label>
							<input type="number" id="InmuebleId" name="InmuebleId" class="form-control"
								placeholder="Ej: 101" readonly>
						</div>
						<div class="col-md-6">
							<label for="InquilinoId" class="form-label">Inquilino ID</label>
							<input type="number" id="InquilinoId" name="InquilinoId" class="form-control"
								placeholder="Ej: 202" readonly>
						</div>
						<div class="col-md-6">
							<label for="FechaInicio" class="form-label">Fecha Inicio</label>
							<input type="date" id="FechaInicio" name="FechaInicio" class="form-control">
						</div>
						<div class="col-md-6">
							<label for="FechaFin" class="form-label">Fecha Fin</label>
							<input type="date" id="FechaFin" name="FechaFin" class="form-control">
						</div>
						<div class="col-md-6">
							<label for="Moneda" class="form-label">Moneda</label>
							<select id="Moneda" name="Moneda" class="form-select">
								<option value="ARS">ARS</option>
								<option value="USD">USD</option>
							</select>
						</div>
						<div class="col-md-6">
							<label for="MontoMensual" class="form-label">Monto Mensual</label>
							<input type="number" id="MontoMensual" name="MontoMensual" class="form-control" step="0.01">
						</div>
						<div class="col-md-6">
							<label for="Deposito" class="form-label">Depósito</label>
							<input type="number" id="Deposito" name="Deposito" class="form-control" step="0.01">
						</div>
						<div class="col-12">
							<label for="Observaciones" class="form-label">Observaciones</label>
							<textarea id="Observaciones" name="Observaciones" class="form-control" rows="3"></textarea>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id="guardarContrato">Guardar</button>
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
			</div>
		</div>
	</div>
</div>


<!-- Modal Confirmación -->
<div class="modal fade" id="modalConfirmacion" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Confirmar Envío de Contrato</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
			</div>
			<div class="modal-body" id="confirmBody">
				<!-- Datos se llenan con JS -->
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
				<button type="button" class="btn btn-primary" id="confirmarContrato">Confirmar</button>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script>

		// Función para cargar propietarios en el modal. 
		function cargarPropietarios(pagina) {
			$.get('/Inmueble/ListarParaSeleccionInmuebles?pagina=' + pagina, function (data) {
				$('#contenedorInmuebles').html(data);
			});
		}

		// Cuando se abre el modal, cargamos la primera página
		$('#modalInmuebles').on('shown.bs.modal', function () {
			cargarPropietarios(1);
		});

		// Delegamos el click en la paginación
		$(document).on('click', '.cargar-pagina', function () {
			let pagina = $(this).data('pagina');
			cargarPropietarios(pagina);
		});

		// Delegamos el click en "Seleccionar"
		$(document).on('click', '.seleccionar-inmueble', function () {
			//El id del inmueble lo obtenemos del data set en el boton seleccionar de _ListaInmueblesSeleccion Partial
			let inmuebleId = $(this).data('id');

			//El id de inquilino lo obtenemos del data set del boton que abre el modal
			let inquilinoId = $('.btn-abrir-inmuebles').data('inquilino-id');

			$('#InmuebleId').val(inmuebleId);

			$('#InquilinoId').val(inquilinoId);

			// Cerrar modal de inmuebles
			$('#modalInmuebles').modal('hide');

			// Abrir modal de contrato
			const contratoModal = new bootstrap.Modal(document.getElementById('modalContrato'));
			contratoModal.show();
		});



		document.getElementById("guardarContrato").addEventListener("click", () => {
			const confirmModal = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
			const body = document.getElementById("confirmBody");
			body.innerHTML = `
									      <p><strong>Inmueble ID:</strong> ${document.getElementById("InmuebleId").value}</p>
									      <p><strong>Inquilino ID:</strong> ${document.getElementById("InquilinoId").value}</p>
									      <p><strong>Fecha Inicio:</strong> ${document.getElementById("FechaInicio").value}</p>
									      <p><strong>Fecha Fin:</strong> ${document.getElementById("FechaFin").value}</p>
									      <p><strong>Moneda:</strong> ${document.getElementById("Moneda").value}</p>
									      <p><strong>Monto Mensual:</strong> ${document.getElementById("MontoMensual").value}</p>
									      <p><strong>Depósito:</strong> ${document.getElementById("Deposito").value}</p>
									      <p><strong>Observaciones:</strong> ${document.getElementById("Observaciones").value}</p>
									    `;
			bootstrap.Modal.getInstance(document.getElementById('modalContrato')).hide();
			confirmModal.show();
		});


		document.getElementById("confirmarContrato").addEventListener("click", () => {

			const form = document.getElementById("formContrato");


			form.submit();


			bootstrap.Modal.getInstance(document.getElementById('modalConfirmacion')).hide();
		});

	</script>
}
