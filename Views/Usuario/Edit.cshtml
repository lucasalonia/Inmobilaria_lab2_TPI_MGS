@model Inmobilaria_lab2_TPI_MGS.Models.Usuario
@{
    ViewData["Title"] = "Editar Usuario";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-user-edit me-2"></i>Editar Usuario
                    </h3>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>@ViewBag.ErrorMessage
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    
                    <form asp-action="Edit" method="post">
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="Persona.Id" />
                        <input type="hidden" asp-for="FechaCreacion" />
                        <input type="hidden" asp-for="CreadoPor" />
                        <input type="hidden" asp-for="Password" />
                        
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-id-card me-2"></i>Información Personal
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">DNI *</label>
                                        <input type="text" class="form-control" asp-for="Persona.Dni" readonly />
                                        <span asp-validation-for="Persona.Dni" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Sexo *</label>
                                        <select class="form-select" asp-for="Persona.Sexo">
                                            <option value="M">Masculino</option>
                                            <option value="F">Femenino</option>
                                        </select>
                                        <span asp-validation-for="Persona.Sexo" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Nombre *</label>
                                        <input type="text" class="form-control" asp-for="Persona.Nombre" />
                                        <span asp-validation-for="Persona.Nombre" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Apellido *</label>
                                        <input type="text" class="form-control" asp-for="Persona.Apellido" />
                                        <span asp-validation-for="Persona.Apellido" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Email *</label>
                                        <input type="email" class="form-control" asp-for="Persona.Email" />
                                        <span asp-validation-for="Persona.Email" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Teléfono</label>
                                        <input type="tel" class="form-control" asp-for="Persona.Telefono" />
                                        <span asp-validation-for="Persona.Telefono" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Fecha de Nacimiento *</label>
                                        <input type="date" class="form-control" asp-for="Persona.FechaNacimiento" />
                                        <span asp-validation-for="Persona.FechaNacimiento" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h5 class="text-success mb-3">
                                <i class="fas fa-user-shield me-2"></i>Información de Usuario
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Nombre de Usuario *</label>
                                        <input type="text" class="form-control" asp-for="UserName" />
                                        <span asp-validation-for="UserName" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Estado *</label>
                                        <select class="form-select" asp-for="Estado">
                                            <option value="ACTIVO">Activo</option>
                                            <option value="INACTIVO">Inactivo</option>
                                        </select>
                                        <span asp-validation-for="Estado" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Nueva Contraseña</label>
                                        <input type="password" class="form-control" name="nuevaPassword" id="nuevaPassword" />
                                        <small class="text-muted">Deje en blanco para mantener la contraseña actual</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Confirmar Nueva Contraseña</label>
                                        <input type="password" class="form-control" name="confirmarPassword" id="confirmarPassword" />
                                        <span id="passwordMatch" class="text-danger" style="display: none;">Las contraseñas no coinciden</span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Rol</label>
                                        <select class="form-select" name="rolId">
                                            <option value="0">Sin rol</option>
                                            @if (ViewBag.Roles != null)
                                            {
                                                @foreach (var rol in ViewBag.Roles)
                                                {
                                                    <option value="@rol.Id" selected="@(ViewBag.RolActual != null && ViewBag.RolActual == rol.Id)">
                                                        @rol.Nombre
                                                    </option>
                                                }
                                            }
                                        </select>
                                        <small class="text-muted">Seleccione un rol para el usuario (opcional)</small>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const nuevaPassword = document.getElementById('nuevaPassword');
            const confirmarPassword = document.getElementById('confirmarPassword');
            const passwordMatch = document.getElementById('passwordMatch');
            const form = document.querySelector('form');

            function validatePasswords() {
                if (nuevaPassword.value && confirmarPassword.value) {
                    if (nuevaPassword.value !== confirmarPassword.value) {
                        passwordMatch.style.display = 'block';
                        return false;
                    } else {
                        passwordMatch.style.display = 'none';
                        return true;
                    }
                }
                return true;
            }

            confirmarPassword.addEventListener('input', validatePasswords);
            nuevaPassword.addEventListener('input', validatePasswords);

            form.addEventListener('submit', function(e) {
                if (!validatePasswords()) {
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
}
